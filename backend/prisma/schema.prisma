generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  password     String
  firstName    String
  lastName     String
  phone        String?
  avatarUrl    String?
  refreshToken String?

  // Password reset
  passwordResetToken   String?
  passwordResetExpires DateTime?

  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  members                 Member[]
  activities              Activity[]
  notifications           Notification[]          @relation("UserNotifications")
  fcmTokens               FcmToken[]              @relation("UserFcmTokens")
  notificationPreferences NotificationPreference? @relation("UserNotificationPreferences")
}

model Cooperative {
  id                 String             @id @default(cuid())
  name               String
  code               String             @unique
  description        String?
  imageUrl           String?
  useGradient        Boolean            @default(true)
  gradientPreset     String             @default("ocean")
  status             String
  createdBy          String?
  memberCount        Int                @default(0)
  totalContributions Int                @default(0)
  totalExpenses      Int                @default(0)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  members            Member[]
  contributionPlans  ContributionPlan[]
  groupBuys          GroupBuy[]
  activities         Activity[]
  notifications      Notification[]     @relation("CooperativeNotifications")
  subscription       Subscription?
  expenseCategories  ExpenseCategory[]
  expenses           Expense[]
}

model Member {
  id            String      @id @default(cuid())
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])
  cooperativeId String
  user          User?       @relation(fields: [userId], references: [id])
  userId        String?

  // For offline/proxy members (when userId is null)
  isOfflineMember Boolean @default(false)
  firstName       String? // Required for offline members
  lastName        String? // Required for offline members
  email           String? // Optional for offline members
  phone           String? // Optional for offline members
  memberCode      String? // Unique identifier within cooperative (e.g., membership number)
  notes           String? // Admin notes about this member
  addedBy         String? // userId of admin who added this offline member

  role                      String // 'admin' | 'moderator' | 'member'
  permissions               String? // JSON string of permissions array
  joinedAt                  DateTime
  virtualBalance            Int                        @default(0)
  status                    String
  contributionRecords       ContributionRecord[]
  contributionSubscriptions ContributionSubscription[]
  contributionPayments      ContributionPayment[]
  loans                     Loan[]
  groupBuyOrders            GroupBuyOrder[]

  @@unique([cooperativeId, memberCode])
}

model ContributionPlan {
  id            String      @id @default(cuid())
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])
  cooperativeId String
  name          String
  description   String?

  // Category: compulsory or optional
  category String // 'compulsory' | 'optional'

  // Amount type: fixed (set by admin) or notional (set by member)
  amountType  String // 'fixed' | 'notional'
  fixedAmount Int? // Required if amountType is 'fixed'
  minAmount   Int? // Optional min for notional
  maxAmount   Int? // Optional max for notional

  // Contribution type: continuous or period-based
  contributionType String // 'continuous' | 'period'
  frequency        String? // 'daily' | 'weekly' | 'monthly' | 'yearly'
  startDate        DateTime?
  endDate          DateTime? // Required if contributionType is 'period'

  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  periods       ContributionPeriod[]
  subscriptions ContributionSubscription[]
}

model ContributionSubscription {
  id       String           @id @default(cuid())
  plan     ContributionPlan @relation(fields: [planId], references: [id])
  planId   String
  member   Member           @relation(fields: [memberId], references: [id])
  memberId String

  // Amount committed (for notional plans, this is member-defined)
  amount Int

  // Balance tracking for this subscription
  totalPaid Int @default(0)

  status       String // 'active' | 'paused' | 'cancelled'
  subscribedAt DateTime  @default(now())
  pausedAt     DateTime?
  cancelledAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments  ContributionPayment[]
  schedules PaymentSchedule[]

  @@unique([planId, memberId])
}

// Payment schedules - represents expected payment dates for subscriptions
model PaymentSchedule {
  id             String                   @id @default(cuid())
  subscription   ContributionSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId String

  // Schedule details
  dueDate      DateTime // When this payment is due
  amount       Int // Expected amount for this schedule
  periodNumber Int // 1, 2, 3... for tracking which payment period
  periodLabel  String? // e.g., "January 2025", "Week 1"

  // Payment status
  status     String    @default("pending") // 'pending' | 'paid' | 'partial' | 'overdue' | 'waived'
  paidAmount Int       @default(0) // Amount paid towards this schedule
  paidAt     DateTime? // When it was fully paid

  // Linked payment (if paid)
  payment   ContributionPayment? @relation(fields: [paymentId], references: [id])
  paymentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subscriptionId, periodNumber])
  @@index([subscriptionId])
  @@index([dueDate])
  @@index([status])
}

// Payments made by members for their subscriptions
model ContributionPayment {
  id             String                   @id @default(cuid())
  subscription   ContributionSubscription @relation(fields: [subscriptionId], references: [id])
  subscriptionId String
  member         Member                   @relation(fields: [memberId], references: [id])
  memberId       String

  // Payment details
  amount           Int
  paymentDate      DateTime  @default(now())
  dueDate          DateTime? // The due date this payment is for
  paymentMethod    String? // 'bank_transfer' | 'cash' | 'mobile_money' | 'card'
  paymentReference String? // Transaction reference

  // Evidence/receipt
  receiptUrl String?
  notes      String?

  // Approval workflow
  status          String // 'pending' | 'approved' | 'rejected'
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Linked schedule (which schedule this payment is for)
  schedules PaymentSchedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([memberId])
  @@index([status])
}

model ContributionPeriod {
  id              String               @id @default(cuid())
  plan            ContributionPlan     @relation(fields: [planId], references: [id])
  planId          String
  periodNumber    Int
  startDate       DateTime
  endDate         DateTime
  dueDate         DateTime
  expectedAmount  Int
  collectedAmount Int                  @default(0)
  status          String
  records         ContributionRecord[]
}

model ContributionRecord {
  id               String             @id @default(cuid())
  period           ContributionPeriod @relation(fields: [periodId], references: [id])
  periodId         String
  member           Member             @relation(fields: [memberId], references: [id])
  memberId         String
  amount           Int
  paymentDate      DateTime
  paymentReference String?
  receiptUrl       String?
  notes            String?
  status           String
  verifiedBy       String?
  verifiedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model GroupBuy {
  id               String          @id @default(cuid())
  cooperative      Cooperative     @relation(fields: [cooperativeId], references: [id])
  cooperativeId    String
  title            String
  description      String?
  imageUrl         String?
  totalUnits       Int
  availableUnits   Int
  unitPrice        Int
  interestRate     Int
  allocationMethod String
  status           String
  createdBy        String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  orders           GroupBuyOrder[]
}

model GroupBuyOrder {
  id                String   @id @default(cuid())
  groupBuy          GroupBuy @relation(fields: [groupBuyId], references: [id])
  groupBuyId        String
  member            Member   @relation(fields: [memberId], references: [id])
  memberId          String
  requestedQuantity Int
  allocatedQuantity Int
  unitPrice         Int
  interestAmount    Int
  totalLiability    Int
  status            String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Loan {
  id            String @id @default(cuid())
  cooperativeId String
  memberId      String
  member        Member @relation(fields: [memberId], references: [id])

  // Loan type reference (optional for legacy loans)
  loanTypeId String?
  loanType   LoanType? @relation(fields: [loanTypeId], references: [id])

  // Loan details
  amount           Int
  purpose          String
  duration         Int // in months
  interestRate     Float // percentage (e.g., 5 for 5%)
  interestAmount   Int // calculated interest amount
  monthlyRepayment Int
  totalRepayment   Int

  // Balance tracking
  amountDisbursed    Int @default(0)
  amountRepaid       Int @default(0)
  outstandingBalance Int @default(0)

  // Fee tracking
  applicationFee         Int @default(0) // Application fee charged
  interestDeductedUpfront Int @default(0) // Interest deducted upfront from disbursement
  netDisbursementAmount  Int @default(0) // Actual amount disbursed after deductions

  // Status and workflow
  status            String // 'pending' | 'approved' | 'rejected' | 'disbursed' | 'repaying' | 'completed' | 'defaulted'
  initiatedBy       String // 'member' | 'admin'
  initiatedByUserId String? // userId of admin who initiated (for admin-initiated loans)

  // Repayment settings
  deductionStartDate DateTime? // When deductions should commence

  // Timeline
  requestedAt     DateTime  @default(now())
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  disbursedAt     DateTime?
  completedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  repaymentSchedules LoanRepaymentSchedule[]

  @@index([cooperativeId])
  @@index([memberId])
  @@index([status])
}

// Loan types configuration for cooperatives
model LoanType {
  id            String @id @default(cuid())
  cooperativeId String

  // Basic info
  name        String // e.g., "Emergency Loan", "Education Loan"
  description String?

  // Loan limits
  minAmount Int // Minimum loan amount
  maxAmount Int // Maximum loan amount

  // Duration limits
  minDuration Int // Minimum repayment duration in months
  maxDuration Int // Maximum repayment duration in months

  // Interest configuration
  interestRate Float // Base interest rate percentage
  interestType String // 'flat' | 'reducing_balance'

  // Eligibility criteria
  minMembershipDuration Int? // Minimum months as member to be eligible
  minSavingsBalance     Int? // Minimum savings/balance to be eligible
  maxActiveLoans        Int  @default(1) // Maximum concurrent loans of this type

  // Guarantor requirements
  requiresGuarantor Boolean @default(false)
  minGuarantors     Int     @default(0)

  // Fee configuration
  applicationFee      Int?     // Optional application fee amount
  deductInterestUpfront Boolean @default(false) // If true, interest is deducted from disbursement

  // Admin settings
  isActive         Boolean @default(true)
  requiresApproval Boolean @default(true) // false = auto-approve

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  loans Loan[]

  @@unique([cooperativeId, name])
  @@index([cooperativeId])
}

// Loan repayment schedule
model LoanRepaymentSchedule {
  id     String @id @default(cuid())
  loanId String
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  // Schedule details
  installmentNumber Int // 1, 2, 3...
  dueDate           DateTime

  // Amounts
  principalAmount Int // Principal portion of this installment
  interestAmount  Int // Interest portion of this installment
  totalAmount     Int // Total due for this installment

  // Payment tracking
  paidAmount Int       @default(0)
  paidAt     DateTime?
  status     String    @default("pending") // 'pending' | 'partial' | 'paid' | 'overdue' | 'waived'

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([loanId, installmentNumber])
  @@index([loanId])
  @@index([dueDate])
  @@index([status])
}

model LedgerEntry {
  id            String   @id @default(cuid())
  cooperativeId String
  memberId      String? // Optional - null for cooperative-level expenses
  type          String // 'contribution', 'loan_disbursement', 'loan_repayment', 'expense', etc.
  amount        Int
  balanceAfter  Int
  referenceId   String?
  referenceType String?
  description   String?
  createdBy     String
  createdAt     DateTime @default(now())

  // Reverse relation for expense
  expense Expense?
}

model Activity {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  cooperativeId String?
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])
  action        String // e.g., 'cooperative.create', 'cooperative.join', 'member.approve', 'loan.request'
  description   String // Human-readable description
  metadata      Json? // Additional context data
  createdAt     DateTime     @default(now())

  @@index([userId])
  @@index([cooperativeId])
  @@index([createdAt])
}

// Push Notification Models
model Notification {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], name: "UserNotifications")
  cooperativeId String?
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id], name: "CooperativeNotifications")
  type          String // notification type
  title         String
  body          String
  data          Json? // Additional data for navigation/actions
  isRead        Boolean      @default(false)
  actionType    String? // view, approve, reject, pay, navigate
  actionRoute   String? // screen/route to navigate to
  actionParams  Json? // route parameters
  createdAt     DateTime     @default(now())
  readAt        DateTime?

  @@index([userId])
  @@index([cooperativeId])
  @@index([isRead])
  @@index([createdAt])
}

model FcmToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], name: "UserFcmTokens")
  token     String   @unique
  platform  String // ios, android
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
}

model NotificationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], name: "UserNotificationPreferences")
  pushEnabled           Boolean  @default(true)
  contributionReminders Boolean  @default(true)
  loanUpdates           Boolean  @default(true)
  groupBuyUpdates       Boolean  @default(true)
  memberUpdates         Boolean  @default(true)
  announcements         Boolean  @default(true)
  mentions              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ========== SUBSCRIPTION & BILLING MODELS ==========

// Subscription plans available in the system
model SubscriptionPlan {
  id          String  @id @default(cuid())
  name        String  @unique // 'free', 'starter', 'business', 'enterprise'
  displayName String // 'Free', 'Starter', 'Business', 'Enterprise'
  description String?

  // Pricing
  monthlyPrice Int    @default(0) // Price in kobo (Nigerian currency smallest unit)
  yearlyPrice  Int    @default(0) // Annual price with discount
  currency     String @default("NGN")

  // Limits
  maxMembers           Int @default(20) // Max members per cooperative
  maxContributionPlans Int @default(1) // Max contribution plans
  maxLoansPerMonth     Int @default(0) // Max loan requests per month (0 = disabled)
  maxGroupBuys         Int @default(0) // Max active group buys (0 = disabled)

  // Features (JSON for flexibility)
  features Json? // Array of feature strings for display

  // Flags
  isActive  Boolean @default(true)
  isPopular Boolean @default(false) // Highlight as recommended
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

// Active subscriptions for cooperatives
model Subscription {
  id String @id @default(cuid())

  // Link to cooperative
  cooperativeId String      @unique
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])

  // Link to plan
  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  // Subscription status
  status String @default("active") // 'active', 'cancelled', 'expired', 'past_due', 'trialing'

  // Billing cycle
  billingCycle       String   @default("monthly") // 'monthly', 'yearly'
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime

  // Trial period
  trialEndsAt DateTime?

  // Cancellation
  cancelledAt       DateTime?
  cancelReason      String?
  cancelAtPeriodEnd Boolean   @default(false)

  // Paystack integration
  paystackCustomerCode     String?
  paystackSubscriptionCode String?

  // Metadata
  createdBy String // userId of admin who subscribed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments SubscriptionPayment[]

  @@index([cooperativeId])
  @@index([status])
}

// Payment records for subscriptions
model SubscriptionPayment {
  id String @id @default(cuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  // Payment details
  amount   Int // Amount in kobo
  currency String @default("NGN")
  status   String @default("pending") // 'pending', 'success', 'failed', 'refunded'

  // Paystack transaction details
  paystackReference     String    @unique
  paystackTransactionId String?
  paystackPaidAt        DateTime?
  paystackChannel       String? // 'card', 'bank', 'ussd', etc.

  // Card details (masked)
  cardLast4    String?
  cardBrand    String? // 'visa', 'mastercard', etc.
  cardExpMonth String?
  cardExpYear  String?

  // Invoice period
  periodStart DateTime
  periodEnd   DateTime

  // Metadata
  metadata      Json?
  failureReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([paystackReference])
  @@index([status])
}

// Paystack webhook events log
model PaystackWebhookEvent {
  id          String    @id @default(cuid())
  eventType   String // 'charge.success', 'subscription.create', etc.
  eventId     String    @unique // Paystack event ID for idempotency
  payload     Json // Full webhook payload
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?
  createdAt   DateTime  @default(now())

  @@index([eventType])
  @@index([processed])
}

// Expense categories for cooperatives
model ExpenseCategory {
  id            String      @id @default(cuid())
  cooperativeId String
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  name        String
  description String?
  color       String? // Hex color for UI display
  icon        String? // Icon name for UI
  isDefault   Boolean @default(false) // System default categories
  isActive    Boolean @default(true)

  createdBy String // userId who created this category
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expenses Expense[]

  @@unique([cooperativeId, name])
  @@index([cooperativeId])
}

// Expense records for cooperatives
model Expense {
  id            String      @id @default(cuid())
  cooperativeId String
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id], onDelete: Cascade)

  // Category
  categoryId String?
  category   ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Expense details
  title       String
  description String?
  amount      Int // Amount in smallest currency unit (e.g., kobo)
  expenseDate DateTime // Date the expense occurred

  // Vendor/Payee information
  vendorName    String?
  vendorContact String? // Phone or email

  // Receipt/Documentation
  receiptUrl    String? // URL to uploaded receipt image
  receiptNumber String? // Invoice/receipt number

  // Payment details
  paymentMethod    String? // 'cash', 'bank_transfer', 'card', 'mobile_money', etc.
  paymentReference String? // Transaction reference if applicable

  // Approval workflow
  status          String    @default("pending") // 'pending', 'approved', 'rejected'
  approvedBy      String? // userId who approved
  approvedAt      DateTime?
  rejectionReason String?

  // Audit trail
  createdBy String // userId who recorded the expense
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Linked ledger entry (if approved)
  ledgerEntryId String?      @unique
  ledgerEntry   LedgerEntry? @relation(fields: [ledgerEntryId], references: [id])

  @@index([cooperativeId])
  @@index([categoryId])
  @@index([status])
  @@index([expenseDate])
  @@index([createdBy])
}
